language: go
go: "1.10"

os: linux
sudo: required
dist: trusty

services:
  - docker

addons:
  artifacts: true

jobs:
  include:
    - stage: test
      name: "Test and lint gotapdance"
      install:
        - go get -t ./...
        - go get github.com/golang/lint/golint
        - go get github.com/alecthomas/gometalinter
      script:
        - go test -race -v ./tapdance
        - go test -race -v ./tdproxy
        - gometalinter --install
        - gometalinter --disable-all -E vet -E gofmt -E misspell -E ineffassign -E deadcode --tests ./tapdance

    - &build
      stage: build
      name: "Build cli and Psiphon ConsoleClient on Linux"
      install:
        - go get ./...
        - mkdir -p $GOPATH/src/github.com/Psiphon-Labs
        - git clone https://github.com/Psiphon-Labs/psiphon-tunnel-core.git $GOPATH/src/github.com/Psiphon-Labs/psiphon-tunnel-core
        - go get github.com/kardianos/govendor
        - (cd $GOPATH/src/github.com/Psiphon-Labs/psiphon-tunnel-core && govendor remove github.com/sergeyfrolov/gotapdance/...)
        - sed -i -e 's/refraction_networking_tapdance.Logger().Out = ioutil.Discard//' $GOPATH/src/github.com/Psiphon-Labs/psiphon-tunnel-core/psiphon/common/tapdance/tapdance.go
        - mkdir build
      script:
        - go build -o build/cli ./cli
        - go build -o build/ConsoleClient -tags 'TAPDANCE' github.com/Psiphon-Labs/psiphon-tunnel-core/ConsoleClient

    - <<: *build
      name: "Build cli and Psiphon ConsoleClient on OS X"
      os: osx

    - <<: *build
      name: "Build Psiphon Android Library"
      before_script:
        - docker pull refraction/psiandroid
      script:
        - docker run -v $GOPATH/src/github.com/Psiphon-Labs/psiphon-tunnel-core:/go/src/github.com/Psiphon-Labs/psiphon-tunnel-core refraction/psiandroid /bin/bash -c 'cd /go/src/github.com/Psiphon-Labs/psiphon-tunnel-core/MobileLibrary/Android && ./make.bash "TAPDANCE"'
        - mv $GOPATH/src/github.com/Psiphon-Labs/psiphon-tunnel-core/MobileLibrary/Android/ca.psiphon.aar build/
